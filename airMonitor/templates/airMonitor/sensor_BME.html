{% extends 'base.html' %} 

{% block title %} BME280 Sensor {% endblock %}

{% block content %}

<h1 name="SDSdetailsPage"></h1>

<!-- Container 1: Sensor location and information -->
<div class="container"> 
	<!-- Row 1: sensor information (table) -->
	<div class="row table-responsive"> 
		<table class="table table-striped table-bordered table-hover align-middle caption-top w-100" style="text-align: center;">
			<caption style="text-align:center; color: black;"> <h1> Sensor Information </h1> </caption>
			<thead class="table-secondary align-middle">
				<tr>
					<th> Sensor ID </th>
					<td>{{ sType.sensorID }}</td>
				</tr>
				<tr>
					<th> Longitude </th>
					<td> {{ sType.longitude }} </td>
				</tr>
				<tr>
					<th> Latitude </th>
					<td> {{ sType.latitude }} </td>
				</tr>
				<tr>
					<th> Location ID </th>
					<td> {{ sType.location_id }} </td>
				</tr>
				<tr>
					<th> Map Location: </th>
					<td class="col d-flex align-items-center justify-content-center">
						<div id='map' style='width: 200px; height: 200px; '>
							<script>
								mapboxgl.accessToken = 'pk.eyJ1IjoieGVudGVycmEiLCJhIjoiY2w0NW4wOHBzMDA3NDNrczA5bHVwaHZqbyJ9.-vV70Us_kN66fPKzCGSLxg';
								var map = new mapboxgl.Map({
									container: 'map',
									style: 'mapbox://styles/mapbox/streets-v11',
									center: [{{sType.longitude}}, {{sType.latitude}}],
									zoom: 10,
								});
								var idList = {{idList}};
								var longitudeList = {{longList}};
								var latitudeList = {{latList}};
								var listLength = {{lLength}};
								var idArray = JSON.parse("[" + idList + "]");
								var longArray = JSON.parse("[" + longitudeList + "]");
								var latArray = JSON.parse("[" + latitudeList + "]");
								for (let r=0; r<listLength; r++){								
									finalHTML = ""+{{sType.longitude}}+","+{{sType.latitude}}+""
									popup = new mapboxgl.Popup({ offset: 25 })
									.setHTML(finalHTML);
									marker = new mapboxgl.Marker()
									.setLngLat([longArray[r],latArray[r]])
									.setPopup(popup)
									.addTo(map);
								}
							</script>	
						</div>
					</td>
				</tr>
			</thead>
		</table>
	</div>

	<!-- Row 2: data/charts selection (drop-down list) -->
	<div class="row mb-3">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
		<script>
			$(document).ready(function(){
				$("#sType").on('change',function(){
					$(".display").hide();
					$("#" + $(this).val()).fadeIn(200);
				}).change();
			});
		</script>

		<select name="sType" id="sType">
			<option value="Live"> Live Data </option>
			<option value="Archive"> Past Data </option>
			<option value="Charts"> Data Charts </option>
		</select>
	</div>
</div>



<!-- Container 2: Data or Charts --> 
<!-- Container 2 (1): Live Data --> 
<div class="container my-3 display" id="Live">
	<div class="row">
		<div class="col table-responsive"> 
			<table class="table table-striped table-bordered table-hover align-middle caption-top w-100" style="text-align: center;">
				<caption style="text-align:center; color: black;"> <h1>Live Sensor Data Table </h1> </caption>
				<thead class="table-secondary">
					<tr>
						<th> Timestamp </th>
						<th> Pressure </th>
						<th> Humidity </th>
						<th> Temperature </th>
					</tr>
				</thead>
				<tbody> 
					<tr style="text-align: center;">
						<td> {{liveTimestamp}} </td> 
						<td> {{livePress}} </td>
						<td> {{liveHumi}} </td>
						<td> {{liveTemp}} </td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
</div>

<!-- Container 2(2): past data -->
<div class="container my-3 display" id="Archive">
	<div class="row">
		<div class="col table-responsive"> 
			<table class="table table-striped table-bordered table-hover align-middle caption-top w-100" style="text-align: center;">
				<caption style="text-align:center; color: black;"> <h1>Sensor Data Table </h1> </caption>
				<thead class="table-secondary">
					<tr>
						<th> Timestamp </th>
						<th> Pressure </th>
						<th> Humidity </th>
						<th> Temperature </th>
					</tr>
				</thead>
				<tbody> 
					{% for sensor in results %} 
					<tr style="text-align: center;">
						<td> {{ sensor.timestamp }} </td> 
						<td> {{ sensor.pressure }} </td>
						<td> {{ sensor.humidity }} </td>
						<td> {{ sensor.temperature}} </td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	</div>
</div>


<!-- Container 2(3): Charts -->
<div class="container my-3 display" id="Charts">
	<!-- Chart 1: Temperature -->
	<div class="row justify-content-center" id="container">
		<caption> <h1 style="text-align:center; color: black;"> Data Tables </h1> </caption>
		<canvas id="line-chart1"></canvas>
	</div>
	<!-- Chart 2: Humidity -->
	<div class="row my-3 justify-content-center" id="container2">
		<canvas id="line-chart2"></canvas>
	</div>
	<!-- Chart 3: Pressure -->
	<div class="row justify-content-center" id="container3">
		<canvas id="line-chart3"></canvas>
	</div>
</div>

<!-- already put the link to base.html <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script> -->
<script>
	var config1 = {
		type: 'line',
		data: {
			datasets: [{
				data: {{ tempList|safe }},
				borderColor: 'red',
				backgroundColor: "rgba(0,0,0,0)",
				label: 'Temperature'
			},],
			labels: {{ labelList|safe }}
		},
		options: {
			responsive: true
		}
	};
	var config2 = {
		type: 'line',
		data: {
			datasets: [{
				data: {{ humList|safe }},
				borderColor: 'green',
				backgroundColor: "rgba(0,0,0,0)",
				label: 'Humidity'
			},],
			labels: {{ labelList|safe }}
		},
		options: {
			responsive: true
		}
	};
	var config3 = {
		type: 'line',
		data: {
			datasets: [{
				data: {{ pressList|safe }},
				borderColor: 'black',
				backgroundColor: "rgba(0,0,0,0)",
				label: 'Pressure'
			},],
			labels: {{ labelList|safe }}
		},
		options: {
			responsive: true
		}
	};
	window.onload = function() {
		var ctx1 = document.getElementById('line-chart1').getContext('2d');
		window.myLine1 = new Chart(ctx1, config1);	
		var ctx2 = document.getElementById('line-chart2').getContext('2d');
		window.myLine2 = new Chart(ctx2, config2);	
		var ctx3 = document.getElementById('line-chart3').getContext('2d');
		window.myLine3 = new Chart(ctx3, config3);	
	};
</script>

{% endblock %}