{% extends 'base.html' %} 

{% block title %} DHT22 Sensor {% endblock %}

{% block content %}
<h1 name="DHTdetailsPage"></h1>

<div>
	<table class="table table-striped table-bordered table-hover align-middle caption-top w-100" style="text-align: center;">
				<caption style="text-align:center; color: black;"> <h1>Sensor Information </h1> </caption>
				<thead class="table-danger">
					<tr>
						<th> Sensor ID </th>
						<td>{{ sType.sensorID }}</td>
					</tr>
					<tr>
						<th> Location ID </th>
						<td>{{ sType.location_id }}</td>
					</tr>
					<tr>
						<th>Map Location: </th>
						<td><div id='map' style='width: 200px; height: 200px;'>
							    <script>
							        mapboxgl.accessToken = 'pk.eyJ1IjoieGVudGVycmEiLCJhIjoiY2w0NW4wOHBzMDA3NDNrczA5bHVwaHZqbyJ9.-vV70Us_kN66fPKzCGSLxg';
							        var map = new mapboxgl.Map({
							        	container: 'map',
							        	style: 'mapbox://styles/mapbox/streets-v11',
							        	center: [{{sType.longitude}}, {{sType.latitude}}],
							        	zoom: 10,
							        });
							        var idList = {{idList}};
							        var longitudeList = {{longList}};
							        var latitudeList = {{latList}};
							        var listLength = {{lLength}};
							        var idArray = JSON.parse("[" + idList + "]");
							        var longArray = JSON.parse("[" + longitudeList + "]");
							        var latArray = JSON.parse("[" + latitudeList + "]");
							        for (let r=0; r<listLength; r++){								
							            finalHTML = ""+{{sType.longitude}}+","+{{sType.latitude}}+""
							            popup = new mapboxgl.Popup({ offset: 25 })
							            .setHTML(finalHTML);
							            marker = new mapboxgl.Marker()
							            .setLngLat([longArray[r],latArray[r]])
							            .setPopup(popup)
							            .addTo(map);
							        }
							    </script>	
							</div>
						</td>
					</tr>
				</thead>
				</tbody>
			</table>
</div>




<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
	$(document).ready(function(){
		$("#sType").on('change',function(){
			$(".display").hide();
			$("#" + $(this).val()).fadeIn(200);
		}).change();
	});
</script>

<select name="sType" id="sType">
	<option value="Live"> Live Data </option>
	<option value="Archive"> Past Data </option>
	<option value="Charts"> Data Charts </option>
</select>

<!-- Container 3: Live Sensor Data -->
<div class="display" id="Live">
<div class="container bg-dark my-3" >
	<div class="row bg-info">
		<div class="col table-responsive"> 
			<table class="table table-striped table-bordered table-hover align-middle caption-top w-100" style="text-align: center;">
				<caption style="text-align:center; color: black;"> <h1>Live Sensor Data Table </h1> </caption>
				<thead class="table-danger">
					<tr>
						<th> Timestamp </th>
						<th> Humidity </th>
						<th> Temperature </th>
					</tr>
				</thead>
				<tbody> 
					<tr style="text-align: center;">
						<td> {{liveTimestamp}} </td>
						<td> {{liveHumi}} 	</td>
						<td> {{liveTemp}}	</td> 
					</tr>
				</tbody>
			</table>
		</div>
	</div>
</div>
</div>

<!-- Container 2: Charts -->
<div class="display" id="Charts">
<div id="container" style="margin:0 auto; width:80%;">
	<caption style="text-align:center; color: black;"> <h1>Data Tables </h1> </caption>
	<canvas id="line-chart1"></canvas>
</div>
<div id="container2" style="margin:0 auto; width: 80%;">
	<canvas id="line-chart2"></canvas>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>
<script>
	var config1 = {
		type: 'line',
		data: {
			datasets: [{
				data: {{ tempList|safe }},
				borderColor: 'red',
				backgroundColor: "rgba(0,0,0,0)",
				label: 'Temperature'
			},],
			labels: {{ labelList|safe }}
		},
		options: {
			responsive: true
		}
	};
	var config2 = {
		type: 'line',
		data: {
			datasets: [{
				data: {{ humList|safe }},
				borderColor: 'green',
				backgroundColor: "rgba(0,0,0,0)",
				label: 'Humidity'
			},],
			labels: {{ labelList|safe }}
		},
		options: {
			responsive: true
		}
	};

	window.onload = function() {
		var ctx1 = document.getElementById('line-chart1').getContext('2d');
		window.myLine1 = new Chart(ctx1, config1);	
		var ctx2 = document.getElementById('line-chart2').getContext('2d');
		window.myLine2 = new Chart(ctx2, config2);	
	};
</script>

<!-- Container 1: past sensor data -->
<div class="display" id="Archive">
<div class="container bg-dark my-3">
	<div class="row bg-info">
		<div class="col table-responsive"> 
			<table class="table table-striped table-bordered table-hover align-middle caption-top w-100" style="text-align: center;">
				<caption style="text-align:center; color: black;"> <h1>Sensor Data Table </h1> </caption>
				<thead class="table-danger">
					<tr>
						<th> Timestamp </th>
						<th> Humidity </th>
						<th> Temperature </th>
					</tr>
				</thead>
				<tbody> 
					{% for sensor in results %} 
					<tr style="text-align: center;">
						<td> {{ sensor.timestamp }} </td> 
						<td> {{ sensor.humidity }} </td>
						<td> {{ sensor.temperature }} </td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	</div>
</div>
</div>

{% endblock %}
